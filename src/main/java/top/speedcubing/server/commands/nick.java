package top.speedcubing.server.commands;

import net.minecraft.server.v1_8_R3.EntityPlayer;
import net.minecraft.server.v1_8_R3.PacketPlayOutHeldItemSlot;
import net.minecraft.server.v1_8_R3.PacketPlayOutPlayerInfo;
import net.minecraft.server.v1_8_R3.PacketPlayOutPosition;
import net.minecraft.server.v1_8_R3.PacketPlayOutRespawn;
import net.minecraft.server.v1_8_R3.PacketPlayOutScoreboardTeam;
import org.bukkit.Location;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import top.speedcubing.lib.api.MojangAPI;
import top.speedcubing.lib.bukkit.inventory.BookBuilder;
import top.speedcubing.lib.bukkit.packetwrapper.OutScoreboardTeam;
import top.speedcubing.lib.minecraft.text.ClickEvent;
import top.speedcubing.lib.minecraft.text.HoverEvent;
import top.speedcubing.lib.minecraft.text.TextBuilder;
import top.speedcubing.lib.utils.ByteArrayDataBuilder;
import top.speedcubing.lib.utils.Reflections;
import top.speedcubing.server.database.Database;
import top.speedcubing.server.database.Rank;
import top.speedcubing.server.events.player.NickEvent;
import top.speedcubing.server.lang.GlobalString;
import top.speedcubing.server.player.User;
import top.speedcubing.server.speedcubingServer;
import top.speedcubing.server.utils.config;

import java.io.IOException;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Random;
import java.util.UUID;

public class nick implements CommandExecutor {
    public static final Map<UUID, Boolean> settingNick = new HashMap<>();
    public static final Map<UUID, String> nickName = new HashMap<>();
    public static final Map<UUID, String> nickRank = new HashMap<>();

    public enum NickBook {
        EULA,
        RANK,
        SKIN,
        NAMECHOOSE,
        NAMECUSTOM,
        NAMERANDOM,
        RULE
    }

    public boolean onCommand(CommandSender commandSender, Command command, String s, String[] strings) {
        if (!((NickEvent) new NickEvent((Player) commandSender).call()).isCancelled) {
            Player player = (Player) commandSender;
            if (strings.length == 1) {
                if (strings[0].equalsIgnoreCase("nickeula") && settingNick.get(player.getUniqueId())) {
                    return true;
                } else if (strings[0].equalsIgnoreCase("nickrank") && settingNick.get(player.getUniqueId())) {
                    openNickBook(player, NickBook.RANK);
                    return true;
                } else if (strings[0].contains("nickskin") && settingNick.get(player.getUniqueId())) {
                    switch (strings[0]) {
                        case "nickskindefault":
                            nickRank.put(player.getUniqueId(), "default");
                            break;
                        case "nickskinchamp":
                            nickRank.put(player.getUniqueId(), "champ");
                            break;
                        case "nickskinprime":
                            nickRank.put(player.getUniqueId(), "prime");
                            break;
                        case "nickskinvip":
                            nickRank.put(player.getUniqueId(), "vip");
                            break;
                        case "nickskinyt":
                            nickRank.put(player.getUniqueId(), "yt");
                            break;
                        case "nickskinytplus":
                            nickRank.put(player.getUniqueId(), "ytplus");
                            break;
                    }
                    openNickBook(player, NickBook.SKIN);
                    return true;
                } else if (strings[0].contains("nicknamechoose") && settingNick.get(player.getUniqueId())) {
                    switch (strings[0]) {
                        case "nicknamechoosemyskin":
                            player.performCommand("skin " + User.getUser(player).realName);
                            break;
                        case "nicknamechoosesaskin":
                            break;
                        case "nicknamechooserandomskin":
                            int userid = new Random().nextInt(39975) + 1;
                            String name = Database.connection.select("name").from("playersdata").where("id=" + userid).getString();
                            player.performCommand("skin " + name);
                            player.sendMessage("Â§aSet your skin to " + name);
                            break;
                    }
                    openNickBook(player, NickBook.NAMECHOOSE);
                    return true;
                } else if (strings[0].equalsIgnoreCase("nicknamecustom") && settingNick.get(player.getUniqueId())) {
                    openNickBook(player, NickBook.NAMECUSTOM);
                    return true;
                } else if (strings[0].equalsIgnoreCase("nicknamerandom") && settingNick.get(player.getUniqueId())) {
                    openNickBook(player, NickBook.NAMERANDOM);
                    return true;
                } else if (strings[0].equalsIgnoreCase("nickrule") && settingNick.get(player.getUniqueId())) {
                    openNickBook(player, NickBook.RULE);
                    return true;
                } else if (strings[0].equalsIgnoreCase("reuse")) {
                    String[] datas = Database.connection.select("nickname,nickpriority").from("playersdata").where("id=" + User.getUser(commandSender).id).getStringArray();
                    if (datas[0].equals(""))
                        commandSender.sendMessage("You didn't nicked before! please use /nick <nickname>");
                    else if (datas[0].equals(commandSender.getName()))
                        User.getUser(commandSender).sendLangMessage(GlobalString.alreadyNicked);
                    else nick.nickPlayer(datas[0], datas[1], true, (Player) commandSender,false);
                    return true;
                }
                String name = strings[0];
                User user = User.getUser(commandSender);
                if (name.equals(commandSender.getName()))
                    user.sendLangMessage(GlobalString.nicksameusername);
                else if (name.equals(user.realName))
                    user.sendLangMessage(GlobalString.nickdefaultusername);
                else
                    nickCheck(user, name, user.player, user.dbSelect("nickpriority").getString(),false);
            } else if (strings.length == 2) {
                User user = User.getUser(commandSender);
                if (user.hasPermission("perm.nick.nickrank")) {
                    String name = strings[0];
                    if (config.rankPermissions.containsKey(strings[1].toLowerCase())) {
                        nickCheck(user, name, user.player, strings[1].toLowerCase(),false);
                        user.dbUpdate("nickpriority='" + strings[1].toLowerCase() + "'");
                    } else
                        user.sendLangMessage(GlobalString.unknownRank);
                } else commandSender.sendMessage("/nick <nickname>\n/nick (use the previous nick)");
            } else if (strings.length == 3) {
                User user = User.getUser(commandSender);
                if (user.hasPermission("perm.nick.nickrank") || nickRank.get(player.getUniqueId()).equals("default")) {
                    String name = strings[0];
                    if (config.rankPermissions.containsKey(strings[1].toLowerCase())) {
                        nickCheck(user, name, user.player, strings[1].toLowerCase(), Boolean.parseBoolean(strings[2]));
                        user.dbUpdate("nickpriority='" + strings[1].toLowerCase() + "'");
                        if (strings[2].equalsIgnoreCase("true")) {
                            openNickBook(player, NickBook.RULE);
                        }
                    } else
                        user.sendLangMessage(GlobalString.unknownRank);
                } else commandSender.sendMessage("/nick <nickname>\n/nick (use the previous nick)");
            } else if (strings.length == 0) {
                settingNick.put(player.getUniqueId(), true);
                openNickBook(player, NickBook.EULA);
            } else commandSender.sendMessage("/nick <nickname>\n/nick (use the previous nick)");
        }
        return true;
    }


    private void nickCheck(User user, String name, Player player, String rank, boolean openBook) {
        if (!user.hasPermission("perm.nick.customname") && !settingNick.containsKey(user.bGetUniqueId())) {
            openNickBook(player, NickBook.EULA);
            settingNick.put(user.bGetUniqueId(),true);
            return;
        }

        boolean allow = (user.hasPermission("perm.nick.legacyregex") ? speedcubingServer.legacyNameRegex : speedcubingServer.nameRegex).matcher(name).matches() && !Database.connection.exist("playersdata", "name='" + name + "' OR id!='" + user.id + "' AND nickname='" + name + "'");
        if (allow) {
            if (!user.hasPermission("perm.nick.anyname")) {
                try {
                    if (MojangAPI.getByName(name) != null)
                        allow = false;
                } catch (IOException ignored) {
                }
            }
        }
        if (allow)
            nickPlayer(name, rank, true, player, openBook);
        else {
            settingNick.remove(player.getUniqueId());
            nickName.remove(player.getUniqueId());
            nickRank.remove(player.getUniqueId());
            user.sendLangMessage(GlobalString.nicknotavaliable);
        }
    }

    public static void nickPlayer(String name, String rank, boolean nick, Player player, boolean openBook) {
        User user = User.getUser(player);
        EntityPlayer entityPlayer = user.toNMS();
        settingNick.remove(user.bGetUniqueId());
        nickName.remove(user.bGetUniqueId());
        nickRank.remove(user.bGetUniqueId());

        //guild
        String tag = Database.connection.select("tag").from("guild").where("name='" + user.getGuild() + "'").getString();
        tag = nick ? "" : (tag == null ? "" : " Â§6[" + tag + "]");

        String extracted2 = speedcubingServer.getCode(rank) + speedcubingServer.playerNameExtract(name);
        PacketPlayOutScoreboardTeam old = new OutScoreboardTeam().a(speedcubingServer.getCode(user.displayRank) + speedcubingServer.playerNameExtract(player.getName())).h(1).packet;
        user.leavePacket = new OutScoreboardTeam().a(extracted2).h(1).packet;
        user.joinPacket = new OutScoreboardTeam().a(extracted2).c(Rank.getFormat(rank, user.id)[0]).d(tag).g(Collections.singletonList(name)).h(0).packet;

        for (User u : User.getUsers())
            if (u != user)
                u.sendPacket(old);

        Reflections.setField(entityPlayer.getProfile(), "name", name);

        for (User u : User.getUsers()) {
            u.bHidePlayer(player);
            u.bShowPlayer(player);
            u.sendPacket(user.leavePacket, user.joinPacket);
        }
        Location l = player.getLocation();
        user.sendPacket(
                new PacketPlayOutPlayerInfo(PacketPlayOutPlayerInfo.EnumPlayerInfoAction.REMOVE_PLAYER, entityPlayer),
                new PacketPlayOutPlayerInfo(PacketPlayOutPlayerInfo.EnumPlayerInfoAction.ADD_PLAYER, entityPlayer),
                new PacketPlayOutRespawn(player.getWorld().getEnvironment().getId(), entityPlayer.world.getDifficulty(), entityPlayer.world.getWorldData().getType(), entityPlayer.playerInteractManager.getGameMode()),
                new PacketPlayOutPosition(l.getX(), l.getY(), l.getZ(), l.getYaw(), l.getPitch(), new HashSet<>()));
        new PacketPlayOutHeldItemSlot(player.getInventory().getHeldItemSlot());
        player.updateInventory();
        user.dbUpdate("nicked=" + (nick ? 1 : 0) + (nick ? ",nickname='" + name + "'" : ""));
        Database.connection.update("onlineplayer", "displayname='" + rank + "',displayrank='" + name + "'", "id=" + user.id);
        speedcubingServer.tcpClient.send(user.tcpPort, new ByteArrayDataBuilder().writeUTF("nick").writeInt(user.id).writeUTF(rank).writeUTF(name).toByteArray());
        user.displayRank = rank;
        if (openBook) {
            openNickBook(player,NickBook.RULE);
        }
    }

    public static void openNickBook(Player player, NickBook type) {
        ItemStack book;
        switch (type) {
            case EULA:
                book = new BookBuilder("eula", "system")
                        .addPage(new TextBuilder().str("å¿ååè½åè¨±ä½ ä½¿ç¨ä¸åçç©å®¶åç¨±ä»¥é²æ­¢è¢«èªåº\n\nä½ ä»ç¶å¿é éµå®ææè¦å®,ä½ ä¸æ¨£å¯ä»¥è¢«æª¢è,ä¸¦ä¸ææå¿åç´éå°è¢«ä¿ç")
                                .both("\n\nâ¤ Â§næäºè§£,éå§è¨­ç½®æçå¿ç¨±", ClickEvent.runCommand("/nick nickrank"), HoverEvent.showText("é»æéè£¡å·²ç¹¼çº"))
                                .toBungee())
                        .build();
                BookBuilder.openBook(book, player);
                break;
            case RANK:
                if (User.getUser(player).hasPermission("perm.nick.nickrank")) {
                    book = new BookBuilder("rank", "system")
                            .addPage(new TextBuilder().str("è®æåéå§è¨­ç½®ä½ çæ±ç¨±!\né¦å,è«é¸æä¸åä½ å¨å¿åæé¡¯ç¤ºçÂ§lRANK\n\n")
                                    .both("Â§0â¤ Â§8DEFAULT\n", ClickEvent.runCommand("/nick nickskindefault"), HoverEvent.showText("é»æéè£¡ä¾é¸æ Â§8DEFAULT"))
                                    .both("Â§0â¤ Â§3CHAMP\n", ClickEvent.runCommand("/nick nickskinchamp"), HoverEvent.showText("é»æéè£¡ä¾é¸æ Â§3CHAMP"))
                                    .both("Â§0â¤ Â§6PRIME\n", ClickEvent.runCommand("/nick nickskinprime"), HoverEvent.showText("é»æéè£¡ä¾é¸æ Â§6PRIME"))
                                    .both("Â§0â¤ Â§dVIP\n", ClickEvent.runCommand("/nick nickskinvip"), HoverEvent.showText("é»æéè£¡ä¾é¸æ Â§dVIP"))
                                    .both("Â§0â¤ Â§5YT\n", ClickEvent.runCommand("/nick nickskinyt"), HoverEvent.showText("é»æéè£¡ä¾é¸æ Â§5YT"))
                                    .both("Â§0â¤ Â§4YT+\n", ClickEvent.runCommand("/nick nickskinytplus"), HoverEvent.showText("é»æéè£¡ä¾é¸æ Â§4YT+"))
                                    .toBungee())
                            .build();
                } else {
                    book = new BookBuilder("rank", "system")
                            .addPage(new TextBuilder().str("è®æåéå§è¨­ç½®ä½ çæ±ç¨±!\né¦å,è«é¸æä¸åä½ å¨å¿åæé¡¯ç¤ºçÂ§lRANK\n\n")
                                    .both("Â§0â¤ Â§8DEFAULT\n", ClickEvent.runCommand("/nick nickskindefault"), HoverEvent.showText("é»æéè£¡ä¾é¸æ Â§8DEFAULT"))
                                    .toBungee())
                            .build();
                }
                BookBuilder.openBook(book, player);
                break;
            case SKIN:
                book = new BookBuilder("skin", "system")
                        .addPage(new TextBuilder().str("å¾å¥½! ç¾å¨é¸æä¸åå¨ä½ å¿åæç Â§lSKINÂ§rÂ§0\n\n")
                                .both("â¤ æç skin\n", ClickEvent.runCommand("/nick nicknamechoosemyskin"), HoverEvent.showText("é»æéè£¡ä¾ä½¿ç¨ä½ èªå·±çskin"))
                                .both("â¤ Steve/Alex skin\n", ClickEvent.runCommand("/nick nicknamechoosesaskin"), HoverEvent.showText("é»æéè£¡ä¾ä½¿ç¨Steveææ¯Alexçskin"))
                                .both("â¤ é¨æ© skin\n", ClickEvent.runCommand("/nick nicknamechooserandomskin"), HoverEvent.showText("é»æéè£¡ä¾ä½¿ç¨é¨æ©skin"))
                                .toBungee())
                        .build();
                BookBuilder.openBook(book, player);
                break;
            case NAMECHOOSE:
                String data = Database.connection.select("nickname").from("playersdata").where("id=" + User.getUser(player).id).getString();
                if (User.getUser(player).hasPermission("perm.nick.customname")) {
                    book = new BookBuilder("name", "system")
                            .addPage(new TextBuilder().str("ç¾å¨ä½ éè¦é¸æä¸åæ±ç¨±åç¨±ä¾ä½¿ç¨\n")
                                    .both("â¤ è¼¸å¥ä¸ååç¨±\n", ClickEvent.runCommand("/nick nicknamecustom"), HoverEvent.showText("éå¨å¯«éæ²ç¨"))
                                    .both("â¤ ä½¿ç¨é¨æ©åç¨±\n", ClickEvent.runCommand("/nick nicknamerandom"), HoverEvent.showText("é»æéè£¡ä¾ä½¿ç¨é¨æ©åç¨±"))
                                    .both("â¤ ç¹¼çºä½¿ç¨ '" + data + "'\n\n", ClickEvent.runCommand("/nick " + data + " " + nickRank.get(player.getUniqueId()) + " true"), HoverEvent.showText("é»æéè£¡ä¾ä½¿ç¨ä¸æ¬¡çåç¨±"))
                                    .str("å¦æä½ æ³è¦è§£é¤å¿åçæå¯ä»¥è¼¸å¥\nÂ§l/unnick")
                                    .toBungee())
                            .build();
                } else {
                    book = new BookBuilder("name", "system")
                            .addPage(new TextBuilder().str("ç¾å¨ä½ éè¦é¸æä¸åæ±ç¨±åç¨±ä¾ä½¿ç¨\n")
                                    .both("â¤ ä½¿ç¨é¨æ©åç¨±\n", ClickEvent.runCommand("/nick nicknamerandom"), HoverEvent.showText("é»æéè£¡ä¾ä½¿ç¨é¨æ©åç¨±"))
                                    .both("â¤ ç¹¼çºä½¿ç¨ '" + data + "'\n\n", ClickEvent.runCommand("/nick " + data + " " + nickRank.get(player.getUniqueId()) + " true"), HoverEvent.showText("é»æéè£¡ä¾ä½¿ç¨ä¸æ¬¡çåç¨±"))
                                    .str("å¦æä½ æ³è¦è§£é¤å¿åçæå¯ä»¥è¼¸å¥\nÂ§l/unnick")
                                    .toBungee())
                            .build();
                }
                BookBuilder.openBook(book, player);
                break;
            case NAMECUSTOM:
                //ä¹å¾åå¯«
                break;
            case NAMERANDOM:
                String name = generateRandomString();
                book = new BookBuilder("random", "system")
                        .addPage(new TextBuilder().str("æåçºä½ çæäºä¸åé¨æ©åç¨±:\nÂ§l" + name + "\n\n")
                                .both("   Â§aÂ§nUSE NAMEÂ§r\n", ClickEvent.runCommand("/nick " + name + " " + nickRank.get(player.getUniqueId()) + " true"), HoverEvent.showText("é»æéè£¡ä¾ä½¿ç¨éååç¨±"))
                                .both("   Â§cÂ§nTRY AGAINÂ§r\n", ClickEvent.runCommand("/nick nicknamerandom"), HoverEvent.showText("é»æéè£¡ä¾ç¢çæ°çåç¨±"))
                                .both("\nÂ§0Â§nææ¯é»æéè£¡ä¾ä½¿ç¨èªè¨åç¨±", ClickEvent.runCommand("/nick nicknamecustom"), HoverEvent.showText("é»æéè£¡ä¾èªè¨åç¨±"))
                                .toBungee())
                        .build();
                BookBuilder.openBook(book, player);
                break;
            case RULE:
                book = new BookBuilder("rule", "system")
                        .addPage(new TextBuilder().str("ä½ å·²ç¶è¨­å®å®ä½ çæ±ç¨±äº!\n\nä½ ç¾å¨çæ±ç¨±æ¯:\n" + User.getUser(player).getPrefixName(false) + "." +
                                        "\n\nÂ§0è¥è¦è§£é¤æ±åçæè«è¼¸å¥:\nÂ§l/unnick")
                                .toBungee())
                        .build();
                BookBuilder.openBook(book, player);
                break;
        }
    }
    public static String generateRandomString() {
        String characters = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_";
        StringBuilder sb = new StringBuilder();
        Random random = new Random();
        int minLength = 4;
        int maxLength = 16;
        int length = random.nextInt(maxLength - minLength + 1) + minLength;

        for (int i = 0; i < length; i++) {
            int index = random.nextInt(characters.length());
            sb.append(characters.charAt(index));
        }

        return sb.toString();
    }
}